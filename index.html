<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="·ª®ng d·ª•ng qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n ƒë∆°n gi·∫£n, ho·∫°t ƒë·ªông offline">
    <meta name="theme-color" content="#2d5016">
    <link rel="manifest" href="manifest.json">
    <title>üìí Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #5a8f3e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1a1a1a;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #2d5016 0%, #5a8f3e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
        }

        /* Filter Section */
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button, select, input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button {
            background: #2d5016;
            color: white;
            border: none;
        }

        button:hover {
            background: #1e3a0f;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        button.danger {
            background: #8b4513;
            border: none;
        }

        button.danger:hover {
            background: #6b3410;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        button.success {
            background: #2d5016;
            border: none;
        }

        button.success:hover {
            background: #1e3a0f;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        select, input[type="text"], input[type="number"], input[type="date"] {
            border: 2px solid #2d5016;
            background: white;
            padding: 12px;
            font-size: 1em;
            border-radius: 8px;
        }

        /* KPI Cards */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #4a7c59 0%, #6b9c7a 100%);
            color: white;
            padding: 28px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .kpi-card.income {
            background: linear-gradient(135deg, #2d6a4f 0%, #52b788 100%);
        }

        .kpi-card.expense {
            background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%);
        }

        .kpi-card.balance {
            background: linear-gradient(135deg, #1e6091 0%, #4093c6 100%);
        }

        .kpi-card.savings {
            background: linear-gradient(135deg, #2d5016 0%, #5a8f3e 100%);
        }

        .kpi-card.other-expense {
            background: linear-gradient(135deg, #a0522d 0%, #cd853f 100%);
        }

        .kpi-card.over-budget {
            animation: pulse 2s infinite;
            border: 3px solid #e74c3c;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .kpi-label {
            font-size: 1.1em;
            opacity: 0.95;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: bold;
        }

        /* Form Section */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-section h2 {
            margin-bottom: 20px;
            color: #2d5016;
            font-size: 1.8em;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 700;
            color: #2d5016;
            font-size: 1.05em;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Budget Section */
        .budget-section {
            background: #f5f5dc;
            padding: 28px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 3px solid #2d5016;
        }

        .budget-section h2 {
            margin-bottom: 20px;
            color: #2d5016;
            font-size: 1.8em;
            font-weight: 700;
        }

        .budget-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .budget-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .budget-item.over-budget {
            border-color: #e74c3c;
            background: #fee;
        }

        .budget-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .budget-item input {
            width: 100%;
            margin-bottom: 5px;
        }

        .budget-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }

        .budget-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-item-header label {
            flex: 1;
            margin: 0;
        }

        .budget-item-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .budget-target {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .budget-target label {
            font-size: 1em;
            color: #2d5016;
            font-weight: 600;
        }

        .budget-stats {
            font-size: 1em;
            color: #2d5016;
            margin-top: 8px;
            font-weight: 600;
        }

        .budget-stats.over {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.05em;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .view-toggle button {
            flex: 1;
            padding: 14px;
            border: 3px solid #2d5016;
            background: white;
            color: #2d5016;
            font-weight: 600;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
        }

        .view-toggle button.active {
            background: #2d5016;
            color: white;
            border-color: #2d5016;
        }

        .comparison-table {
            margin-top: 20px;
        }

        .comparison-table table {
            font-size: 0.9em;
        }

        .week-month-header {
            background: #f8f9fa;
            font-weight: bold;
        }

        /* Transactions Table */
        .transactions-section {
            margin-bottom: 30px;
        }

        .transactions-section h2 {
            margin-bottom: 20px;
            color: #2d5016;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #2d5016 0%, #5a8f3e 100%);
            color: white;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }

        th {
            font-weight: 700;
            font-size: 1.1em;
        }
        
        td {
            font-size: 1em;
        }

        tbody tr {
            border-bottom: 1px solid #eee;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .transaction-type {
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 1em;
        }

        .transaction-type.income {
            background: #d1e7dd;
            color: #0f5132;
            border: 2px solid #2d5016;
        }

        .transaction-type.expense {
            background: #f8d7da;
            color: #842029;
            border: 2px solid #8b4513;
        }

        .amount {
            font-weight: 700;
            font-size: 1.15em;
        }

        .amount.income {
            color: #2d5016;
        }

        .amount.expense {
            color: #8b4513;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons button {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        /* Chart Section */
        .chart-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .chart-section h2 {
            margin-bottom: 20px;
            color: #2d5016;
            font-size: 1.8em;
            font-weight: 700;
        }

        #expenseChart {
            max-width: 100%;
            height: 400px;
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        /* Footer */
        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #ddd;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }
        }

        /* Hidden file input */
        #csvFileInput {
            display: none;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2d5016;
            font-size: 2.2em;
            font-weight: 700;
        }

        .login-box form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-box input {
            padding: 14px;
            border: 3px solid #2d5016;
            border-radius: 8px;
            font-size: 1.1em;
        }

        .login-box input:focus {
            outline: none;
            border-color: #5a8f3e;
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .login-box button {
            padding: 14px;
            font-size: 1.1em;
            font-weight: 700;
            background: #2d5016;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .login-error {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .login-links {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .login-links a {
            color: #2d5016;
            text-decoration: none;
            font-size: 0.9em;
        }

        .login-links a {
            display: block;
            margin: 5px 0;
        }

        .login-links a:hover {
            text-decoration: underline;
        }

        #verifyEmailDisplay {
            color: #2d5016;
            font-size: 0.9em;
        }

        #verifyCode {
            text-align: center;
            font-size: 24px;
            letter-spacing: 10px;
            font-weight: bold;
        }

        /* Admin Page */
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .admin-content {
            padding: 30px;
        }

        .admin-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            margin-bottom: 15px;
            color: #e74c3c;
        }

        .user-list {
            display: grid;
            gap: 10px;
        }

        .user-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
        }

        .user-info {
            flex: 1;
        }

        .user-info strong {
            color: #2d5016;
            font-size: 1.1em;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            z-index: 1000;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Hide sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Logout Button -->
    <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">üö™ ƒêƒÉng xu·∫•t</button>

    <!-- Login Page -->
    <div id="loginPage" class="page-section active">
        <div class="login-container">
            <div class="login-box">
                <h2>üîê ƒêƒÉng nh·∫≠p</h2>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <input type="text" id="loginUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                    <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
                    <button type="submit">ƒêƒÉng nh·∫≠p</button>
                    <div id="loginError" class="login-error"></div>
                </form>
                <div class="login-links">
                    <a href="#" onclick="showRegister(); return false;">üìù ƒêƒÉng k√Ω t√†i kho·∫£n</a>
                    <br>
                    <a href="#" onclick="showForgotPassword(); return false;">üîë Qu√™n m·∫≠t kh·∫©u?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="page-section">
        <div class="login-container">
            <div class="login-box">
                <h2>üìù ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <input type="text" id="registerUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                    <input type="password" id="registerPassword" placeholder="M·∫≠t kh·∫©u" required>
                    <input type="email" id="registerEmail" placeholder="Email" required>
                    <button type="submit">ƒêƒÉng k√Ω</button>
                    <div id="registerError" class="login-error"></div>
                </form>
                <div class="login-links">
                    <a href="#" onclick="showLogin(); return false;">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Page -->
    <div id="forgotPasswordPage" class="page-section">
        <div class="login-container">
            <div class="login-box">
                <h2>üîë Qu√™n m·∫≠t kh·∫©u</h2>
                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <input type="email" id="forgotEmail" placeholder="Nh·∫≠p email ƒëƒÉng k√Ω" required>
                    <button type="submit">G·ª≠i m√£ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
                    <div id="forgotError" class="login-error"></div>
                </form>
                <div class="login-links">
                    <a href="#" onclick="showLogin(); return false;">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Page -->
    <div id="resetPasswordPage" class="page-section">
        <div class="login-container">
            <div class="login-box">
                <h2>‚úâÔ∏è ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    M√£ x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n.<br>
                    <strong id="resetEmailDisplay"></strong>
                </p>
                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <input type="text" id="resetCode" placeholder="Nh·∫≠p m√£ 4 s·ªë" maxlength="4" pattern="[0-9]{4}" required>
                    <input type="password" id="newPassword" placeholder="M·∫≠t kh·∫©u m·ªõi" required>
                    <input type="password" id="confirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi" required>
                    <button type="submit">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
                    <div id="resetError" class="login-error"></div>
                </form>
                <div class="login-links">
                    <a href="#" onclick="showForgotPassword(); return false;">‚Üê Quay l·∫°i</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="page-section">
        <div class="admin-container">
            <div class="admin-header">
                <h1>‚öôÔ∏è Trang Qu·∫£n tr·ªã</h1>
                <p>Qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng</p>
            </div>
            <div class="admin-content">
                <div class="admin-section">
                    <h3>üë• Danh s√°ch t√†i kho·∫£n ng∆∞·ªùi d√πng</h3>
                    <p style="color: #666; margin-bottom: 15px;">Danh s√°ch t·∫•t c·∫£ t√†i kho·∫£n ƒë√£ ƒëƒÉng k√Ω. Admin ch·ªâ c√≥ th·ªÉ xem t√†i kho·∫£n v√† email, kh√¥ng th·ªÉ xem m·∫≠t kh·∫©u.</p>
                    <div id="userList" class="user-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Page -->
    <div id="appPage" class="page-section">
        <div class="container">
            <!-- Header -->
            <header>
                <h1>üìí Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n</h1>
                <div class="subtitle">Xin ch√†o, <span id="currentUsername"></span></div>
            </header>

        <div class="main-content">
            <!-- Filter & Overview Section -->
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>B·ªô l·ªçc th·ªùi gian:</label>
                        <select id="timeFilter">
                            <option value="thisWeek">Tu·∫ßn n√†y</option>
                            <option value="thisMonth" selected>Th√°ng n√†y</option>
                            <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                            <option value="custom">T√πy ch·ªçn ng√†y</option>
                        </select>
                        <input type="date" id="startDate" style="display:none;">
                        <input type="date" id="endDate" style="display:none;">
                    </div>
                    <div class="filter-group">
                        <label>Danh m·ª•c:</label>
                        <select id="categoryFilter">
                            <option value="all">T·∫•t c·∫£</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <button onclick="clearAllData()" class="danger">üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-section">
                <div class="kpi-card income">
                    <div class="kpi-label">T·ªïng thu nh·∫≠p</div>
                    <div class="kpi-value" id="totalIncome">0 ‚Ç´</div>
                </div>
                <div class="kpi-card expense">
                    <div class="kpi-label">T·ªïng chi ti√™u</div>
                    <div class="kpi-value" id="totalExpense">0 ‚Ç´</div>
                </div>
                <div class="kpi-card balance" id="balanceCard">
                    <div class="kpi-label">S·ªë d∆∞</div>
                    <div class="kpi-value" id="balance">0 ‚Ç´</div>
                </div>
                <div class="kpi-card savings" id="savingsCard" onclick="showSavingsModal()" style="cursor: pointer;">
                    <div class="kpi-label">Ti·∫øt ki·ªám</div>
                    <div class="kpi-value" id="savings">0 ‚Ç´</div>
                </div>
                <div class="kpi-card other-expense">
                    <div class="kpi-label">Chi ti√™u ph√°t sinh</div>
                    <div class="kpi-value" id="otherExpense">0 ‚Ç´</div>
                </div>
            </div>

            <!-- Form Section -->
            <div class="form-section">
                <h2>‚ûï Th√™m giao d·ªãch m·ªõi</h2>
                <form id="transactionForm" onsubmit="addTransaction(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Lo·∫°i giao d·ªãch *</label>
                            <select id="transactionType" required style="padding: 10px; font-size: 1em; border: 2px solid #2d5016; border-radius: 6px;">
                                <option value="income">Thu nh·∫≠p</option>
                                <option value="expense">Chi ti√™u</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>S·ªë ti·ªÅn (VND) *</label>
                            <input type="number" id="amount" min="0" step="1000" required style="padding: 10px; font-size: 1em; border: 2px solid #2d5016; border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label>Danh m·ª•c *</label>
                            <div style="display: flex; gap: 5px; flex-direction: column;">
                                <select id="category" required style="flex: 1; width: 100%; padding: 10px; font-size: 1em; border: 2px solid #2d5016; border-radius: 6px;"></select>
                                <div id="newCategoryInput" style="display: none; flex-direction: column; gap: 5px;">
                                    <input type="text" id="newCategoryName" placeholder="Nh·∫≠p t√™n danh m·ª•c m·ªõi..." style="flex: 1; padding: 12px; border: 2px solid #2d5016; border-radius: 6px; font-size: 1em;">
                                    <div style="display: flex; gap: 5px;">
                                    <button type="button" onclick="addNewCategory()" style="flex: 1; padding: 12px; background: #2d5016; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚úì Th√™m</button>
                                    <button type="button" onclick="cancelAddCategory()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚úó H·ªßy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ng√†y giao d·ªãch *</label>
                            <input type="date" id="transactionDate" required style="padding: 10px; font-size: 1em; border: 2px solid #2d5016; border-radius: 6px;">
                        </div>
                        <div class="form-group full-width">
                            <label>Ghi ch√∫</label>
                            <input type="text" id="note" placeholder="V√≠ d·ª•: ƒÇn tr∆∞a, L∆∞∆°ng th√°ng 10..." style="padding: 10px; font-size: 1em; border: 2px solid #2d5016; border-radius: 6px;">
                        </div>
                    </div>
                    <button type="submit" style="padding: 12px 30px; font-size: 16px;">üíæ L∆∞u giao d·ªãch</button>
                </form>
            </div>

            <!-- Budget Section -->
            <div class="budget-section">
                <h2>üí∞ Qu·∫£n l√Ω ng√¢n s√°ch danh m·ª•c</h2>
                <p style="margin-bottom: 15px; color: #856404;">‚úì Ch·ªçn checkbox ƒë·ªÉ t√≠nh v√†o ti·∫øt ki·ªám | Nh·∫≠p gi√° tr·ªã chi t·ªëi ƒëa cho m·ªói danh m·ª•c chi ti√™u</p>
                <div class="budget-list" id="budgetList"></div>
            </div>

            <!-- Transactions Table -->
            <div class="transactions-section">
                <h2>üìã Danh s√°ch giao d·ªãch</h2>
                <div class="view-toggle">
                    <button id="viewAll" onclick="setViewMode('all')" class="active">T·∫•t c·∫£</button>
                    <button id="viewWeek" onclick="setViewMode('week')">Theo tu·∫ßn</button>
                    <button id="viewMonth" onclick="setViewMode('month')">Theo th√°ng</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>Lo·∫°i</th>
                                <th>Danh m·ª•c</th>
                                <th>Ghi ch√∫</th>
                                <th>S·ªë ti·ªÅn</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                    Ch∆∞a c√≥ giao d·ªãch n√†o. H√£y th√™m giao d·ªãch ƒë·∫ßu ti√™n!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="chart-section">
                <h2>üìä Bi·ªÉu ƒë·ªì chi ti√™u theo danh m·ª•c</h2>
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Made with ‚ù§Ô∏è - Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n</p>
        </footer>
    </div>
    </div>

    <!-- Add Category Modal (Simple Prompt) -->
    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin; // S·ª≠ d·ª•ng c√πng domain v·ªõi frontend
        const ADMIN_USERNAME = 'admin';

        let currentUser = null;
        let authToken = null;

        // Initialize authentication
        function initAuth() {
            // Check if user is logged in
            const savedToken = sessionStorage.getItem('pf_auth_token');
            const savedUser = sessionStorage.getItem('pf_current_user');
            
            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = savedUser;
                showApp();
            } else {
                showLogin();
            }
        }

        // API Helper functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }

            const config = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(url, config);
                
                // Check if response is JSON
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // If not JSON, might be connection error
                    throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ƒë·∫£m b·∫£o server ƒëang ch·∫°y.');
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'L·ªói server');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                
                // Better error messages
                if (error.message.includes('Failed to fetch') || 
                    error.message.includes('NetworkError') ||
                    error.message.includes('Network request failed')) {
                    throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ƒë·∫£m b·∫£o server ƒëang ch·∫°y t·∫°i http://localhost:3000');
                }
                
                throw error;
            }
        }

        function showLogin() {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('logoutBtn').style.display = 'none';
            // Clear form errors
            document.getElementById('loginError').textContent = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showRegister() {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById('registerPage').classList.add('active');
            document.getElementById('registerError').textContent = '';
        }

        function showForgotPassword() {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById('forgotPasswordPage').classList.add('active');
            document.getElementById('forgotError').textContent = '';
        }

        function showResetPassword(email) {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById('resetPasswordPage').classList.add('active');
            document.getElementById('resetEmailDisplay').textContent = email;
            document.getElementById('resetError').textContent = '';
            document.getElementById('resetCode').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function showApp() {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            // Check if user is admin
            const isAdmin = currentUser && currentUser.toLowerCase() === 'admin';
            
            if (isAdmin) {
                document.getElementById('adminPage').classList.add('active');
                renderUserList();
            } else {
                document.getElementById('appPage').classList.add('active');
                document.getElementById('currentUsername').textContent = currentUser;
                init();
            }
            document.getElementById('logoutBtn').style.display = 'block';
        }


        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '';

            try {
                const response = await apiRequest('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                if (response.success && response.token) {
                    authToken = response.token;
                    currentUser = response.username;
                    sessionStorage.setItem('pf_auth_token', authToken);
                    sessionStorage.setItem('pf_current_user', currentUser);
                    showApp();
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {
                    errorDiv.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ƒë·∫£m b·∫£o server ƒëang ch·∫°y t·∫°i http://localhost:3000';
                } else {
                    errorDiv.textContent = error.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!';
                }
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgotEmail').value.trim();
            const errorDiv = document.getElementById('forgotError');
            errorDiv.textContent = '';

            try {
                const response = await apiRequest('/api/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                if (response.success) {
                    showResetPassword(response.email);
                    alert(`M√£ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ${response.email}`);
                }
            } catch (error) {
                errorDiv.textContent = error.message || 'G·ª≠i email th·∫•t b·∫°i!';
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            const code = document.getElementById('resetCode').value;
            const email = document.getElementById('resetEmailDisplay').textContent;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('resetError');
            errorDiv.textContent = '';

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
                return;
            }

            try {
                const response = await apiRequest('/api/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({ code, email, newPassword })
                });

                if (response.success) {
                    alert('ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v·ªõi m·∫≠t kh·∫©u m·ªõi.');
                    showLogin();
                }
            } catch (error) {
                errorDiv.textContent = error.message || 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i!';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value.trim();
            const errorDiv = document.getElementById('registerError');
            errorDiv.textContent = '';

            // Validate
            if (!username || !password || !email) {
                errorDiv.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!';
                return;
            }

            try {
                const response = await apiRequest('/api/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, password, email })
                });

                if (response.success) {
                    alert('ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ngay b√¢y gi·ªù.');
                    showLogin();
                }
            } catch (error) {
                errorDiv.textContent = error.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i!';
            }
        }

        function logout() {
            currentUser = null;
            authToken = null;
            sessionStorage.removeItem('pf_current_user');
            sessionStorage.removeItem('pf_auth_token');
            showLogin();
        }

        async function deleteUser(username) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"?`)) {
                return;
            }

            try {
                await apiRequest(`/api/admin/users/${username}`, {
                    method: 'DELETE'
                });
                alert('ƒê√£ x√≥a t√†i kho·∫£n!');
                renderUserList();
            } catch (error) {
                alert(error.message || 'X√≥a t√†i kho·∫£n th·∫•t b·∫°i!');
            }
        }

        async function renderUserList() {
            const userList = document.getElementById('userList');

            try {
                const response = await apiRequest('/api/admin/users');
                const users = response.users || [];

                if (users.length === 0) {
                    userList.innerHTML = '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ t√†i kho·∫£n n√†o</p>';
                    return;
                }

                userList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #2d5016; color: white;">
                                <th style="padding: 12px; text-align: left;">T√†i kho·∫£n</th>
                                <th style="padding: 12px; text-align: left;">Email</th>
                                <th style="padding: 12px; text-align: left;">Ng√†y ƒëƒÉng k√Ω</th>
                                <th style="padding: 12px; text-align: center;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => {
                                const date = new Date(user.created_at).toLocaleDateString('vi-VN');
                                return `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 12px;"><strong>${user.username}</strong></td>
                                        <td style="padding: 12px;">${user.email}</td>
                                        <td style="padding: 12px;">${date}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="deleteUser('${user.username}')" class="danger">üóëÔ∏è X√≥a</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                userList.innerHTML = `<p style="text-align: center; color: #e74c3c;">L·ªói: ${error.message}</p>`;
            }
        }

        async function loadUserData() {
            try {
                const response = await apiRequest('/api/user/data');
                if (response.data) {
                    state = response.data;
                    if (!state.budgets) state.budgets = {};
                    if (!state.targets) state.targets = {};
                    if (!state.monthlyBalance) state.monthlyBalance = {};
                    if (!state.savingsCategories) state.savingsCategories = {};
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Initialize empty state if no data
                state = { categories: [], transactions: [], budgets: {}, targets: {}, monthlyBalance: {}, savingsCategories: {} };
            }
        }

        async function saveData() {
            try {
                await apiRequest('/api/user/data', {
                    method: 'POST',
                    body: JSON.stringify({ data: state })
                });
            } catch (error) {
                console.error('Error saving data:', error);
                alert('L·ªói l∆∞u d·ªØ li·ªáu! Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        // State management
        let state = {
            categories: [],
            transactions: [],
            budgets: {},
            targets: {},  // Gi√° tr·ªã mong mu·ªën cho m·ªói danh m·ª•c
            monthlyBalance: {},  // S·ªë d∆∞ theo th√°ng: { "2024-01": 1000000, ... }
            savingsCategories: {}  // Danh s√°ch danh m·ª•c ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ t√≠nh ti·∫øt ki·ªám
        };

        // View mode: 'all', 'week', 'month'
        let currentViewMode = 'all';

        // Default categories
        const defaultCategories = {
            income: ['L∆∞∆°ng', 'ƒê∆∞·ª£c b·ªë m·∫π ph·ª• c·∫•p', 'ƒê∆∞·ª£c th∆∞·ªüng'],
            expense: ['ƒÇn u·ªëng', 'ƒêi l·∫°i', 'Sinh ho·∫°t', 'Mua s·∫Øm', 'Gi·∫£i tr√≠', 'Y t·∫ø', 'Gi√°o d·ª•c', 'Ph√°t sinh', 'Kh√°c']
        };

        // Initialize
        async function init() {
            // Authentication is handled by initAuth()
            // This function is called after user logs in
            await loadUserData();
            setupDefaultCategories();
            setupEventListeners();
            setDefaultDate();
            updateCategoryOptions(); // Ensure category dropdown is populated
            render();
        }

        function setupDefaultCategories() {
            if (state.categories.length === 0) {
                defaultCategories.income.forEach(cat => {
                    if (!state.categories.find(c => c.name === cat && c.type === 'income')) {
                        state.categories.push({ name: cat, type: 'income' });
                    }
                });
                defaultCategories.expense.forEach(cat => {
                    if (!state.categories.find(c => c.name === cat && c.type === 'expense')) {
                        state.categories.push({ name: cat, type: 'expense' });
                    }
                });
                saveData();
            }
        }

        function setupEventListeners() {
            document.getElementById('timeFilter').addEventListener('change', function() {
                if (this.value === 'custom') {
                    document.getElementById('startDate').style.display = 'inline-block';
                    document.getElementById('endDate').style.display = 'inline-block';
                } else {
                    document.getElementById('startDate').style.display = 'none';
                    document.getElementById('endDate').style.display = 'none';
                }
                render();
            });

            document.getElementById('categoryFilter').addEventListener('change', render);
            document.getElementById('transactionType').addEventListener('change', updateCategoryOptions);
            document.getElementById('startDate').addEventListener('change', render);
            document.getElementById('endDate').addEventListener('change', render);
            
            // Update category options when page loads
            updateCategoryOptions();
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // Data management
        function saveData() {
            localStorage.setItem('pf_tracker_v1', JSON.stringify(state));
        }

        function loadData() {
            const saved = localStorage.getItem('pf_tracker_v1');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                    // Ensure objects exist
                    if (!state.budgets) state.budgets = {};
                    if (!state.targets) state.targets = {};
                    if (!state.monthlyBalance) state.monthlyBalance = {};
                    if (!state.savingsCategories) state.savingsCategories = {};
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        function clearAllData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                localStorage.removeItem('pf_tracker_v1');
                state = { categories: [], transactions: [], budgets: {}, targets: {}, monthlyBalance: {}, savingsCategories: {} };
                setupDefaultCategories();
                render();
            }
        }

        // Category management
        function updateCategoryOptions() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '';
            
            const categories = state.categories.filter(c => c.type === type);
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
            
            // Th√™m option "Th√™m danh m·ª•c m·ªõi..."
            const addNewOption = document.createElement('option');
            addNewOption.value = '__ADD_NEW__';
            addNewOption.textContent = 'Th√™m danh m·ª•c m·ªõi...';
            addNewOption.style.color = '#007bff';
            addNewOption.style.fontWeight = 'bold';
            categorySelect.appendChild(addNewOption);
            
            // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi
            categorySelect.removeEventListener('change', handleCategoryChange);
            categorySelect.addEventListener('change', handleCategoryChange);
        }
        
        function handleCategoryChange() {
            const categorySelect = document.getElementById('category');
            const newCategoryInput = document.getElementById('newCategoryInput');
            const newCategoryName = document.getElementById('newCategoryName');
            
            if (categorySelect.value === '__ADD_NEW__') {
                // Hi·ªÉn th·ªã input ƒë·ªÉ nh·∫≠p t√™n danh m·ª•c m·ªõi
                newCategoryInput.style.display = 'flex';
                categorySelect.required = false;
                newCategoryName.focus();
            } else {
                // ·∫®n input n·∫øu ch·ªçn danh m·ª•c kh√°c
                newCategoryInput.style.display = 'none';
                categorySelect.required = true;
            }
        }
        
        function addNewCategory() {
            const type = document.getElementById('transactionType').value;
            const newCategoryName = document.getElementById('newCategoryName');
            const categoryName = newCategoryName.value.trim();
            
            if (!categoryName) {
                alert('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c!');
                return;
            }
            
            // Ki·ªÉm tra danh m·ª•c ƒë√£ t·ªìn t·∫°i ch∆∞a
            if (state.categories.find(c => c.name === categoryName && c.type === type)) {
                alert('Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!');
                newCategoryName.value = '';
                newCategoryName.focus();
                return;
            }
            
            // Th√™m danh m·ª•c m·ªõi
            state.categories.push({ name: categoryName, type: type });
            saveData();
            
            // C·∫≠p nh·∫≠t dropdown
            updateCategoryOptions();
            
            // Ch·ªçn danh m·ª•c v·ª´a th√™m
            document.getElementById('category').value = categoryName;
            
            // ·∫®n input v√† reset
            document.getElementById('newCategoryInput').style.display = 'none';
            newCategoryName.value = '';
            document.getElementById('category').required = true;
            
            // Focus v√†o √¥ s·ªë ti·ªÅn
            document.getElementById('amount').focus();
        }
        
        function cancelAddCategory() {
            const newCategoryInput = document.getElementById('newCategoryInput');
            const newCategoryName = document.getElementById('newCategoryName');
            const categorySelect = document.getElementById('category');
            
            // ·∫®n input
            newCategoryInput.style.display = 'none';
            newCategoryName.value = '';
            
            // Reset dropdown v·ªÅ danh m·ª•c ƒë·∫ßu ti√™n
            const type = document.getElementById('transactionType').value;
            const categories = state.categories.filter(c => c.type === type);
            if (categories.length > 0) {
                categorySelect.value = categories[0].name;
            }
            categorySelect.required = true;
        }

        // Function n√†y gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch, nh∆∞ng kh√¥ng c√≤n d√πng n·ªØa
        function showAddCategoryModal() {
            // Kh√¥ng c√≤n d√πng n·ªØa - ƒë√£ thay b·∫±ng option trong dropdown
            const categorySelect = document.getElementById('category');
            categorySelect.value = '__ADD_NEW__';
            handleCategoryChange();
        }

        // Transaction management
        function addTransaction(event) {
            event.preventDefault();
            
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const categorySelect = document.getElementById('category');
            let category = categorySelect.value;
            const date = document.getElementById('transactionDate').value;
            const note = document.getElementById('note').value || '';
            
            // Ki·ªÉm tra n·∫øu ƒëang th√™m danh m·ª•c m·ªõi
            if (category === '__ADD_NEW__') {
                const newCategoryName = document.getElementById('newCategoryName').value.trim();
                if (!newCategoryName) {
                    alert('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c m·ªõi!');
                    document.getElementById('newCategoryName').focus();
                    return;
                }
                
                // Ki·ªÉm tra danh m·ª•c ƒë√£ t·ªìn t·∫°i ch∆∞a
                if (state.categories.find(c => c.name === newCategoryName && c.type === type)) {
                    alert('Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i!');
                    document.getElementById('newCategoryName').focus();
                    return;
                }
                
                // Th√™m danh m·ª•c m·ªõi
                state.categories.push({ name: newCategoryName, type: type });
                saveData();
                category = newCategoryName;
            }

            const transaction = {
                id: Date.now(),
                type: type,
                amount: amount,
                category: category,
                date: date,
                note: note
            };

            state.transactions.unshift(transaction);
            saveData();
            render();
            
            // Reset form
            document.getElementById('transactionForm').reset();
            setDefaultDate();
            updateCategoryOptions();
            
            // ·∫®n input th√™m danh m·ª•c m·ªõi n·∫øu ƒëang hi·ªÉn th·ªã
            document.getElementById('newCategoryInput').style.display = 'none';
        }

        function deleteTransaction(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                saveData();
                render();
            }
        }

        function editTransaction(id) {
            const transaction = state.transactions.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('transactionType').value = transaction.type;
            updateCategoryOptions();
            document.getElementById('category').value = transaction.category;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('note').value = transaction.note;

            // Delete the transaction (will be added again when form is submitted)
            deleteTransaction(id);
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Quick add transaction from budget list
        function quickAddTransaction(type, category) {
            // Set form values
            document.getElementById('transactionType').value = type;
            updateCategoryOptions();
            document.getElementById('category').value = category;
            
            // Set today's date as default
            setDefaultDate();
            
            // Clear amount and note
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            
            // Focus on amount input
            setTimeout(() => {
                document.getElementById('amount').focus();
            }, 300);
        }

        // Budget management
        function updateBudget(category, amount) {
            if (amount === '' || amount === null || isNaN(amount)) {
                delete state.budgets[category];
            } else {
                state.budgets[category] = parseFloat(amount);
            }
            saveData();
            render();
        }

        // Target management (gi√° tr·ªã mong mu·ªën)
        function updateTarget(category, type, amount) {
            const key = `${type}_${category}`;
            if (amount === '' || amount === null || isNaN(amount)) {
                delete state.targets[key];
            } else {
                state.targets[key] = parseFloat(amount);
            }
            saveData();
            render();
        }

        // Savings category checkbox
        function toggleSavingsCategory(category, checked) {
            if (checked) {
                state.savingsCategories[category] = true;
            } else {
                delete state.savingsCategories[category];
            }
            saveData();
            render();
        }
        
        // Calculate monthly balance (s·ªë d∆∞ theo th√°ng)
        function calculateMonthlyBalance() {
            const monthlyData = {};
            
            state.transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0, targetExpense: 0 };
                }
                
                if (transaction.type === 'income') {
                    monthlyData[monthKey].income += transaction.amount;
                } else {
                    monthlyData[monthKey].expense += transaction.amount;
                }
            });
            
            // T√≠nh t·ªïng gi√° tr·ªã mong mu·ªën ti√™u (targets) cho m·ªói th√°ng
            Object.keys(monthlyData).forEach(monthKey => {
                const expenseCategories = state.categories.filter(c => c.type === 'expense');
                let totalTarget = 0;
                expenseCategories.forEach(cat => {
                    const targetKey = `expense_${cat.name}`;
                    const target = state.targets[targetKey] || 0;
                    totalTarget += target;
                });
                monthlyData[monthKey].targetExpense = totalTarget;
                
                // T√≠nh s·ªë d∆∞: Thu nh·∫≠p - Gi√° tr·ªã mong mu·ªën ti√™u
                const income = monthlyData[monthKey].income;
                const balance = income - totalTarget;
                state.monthlyBalance[monthKey] = balance;
            });
            
            saveData();
        }
        
        // Show savings modal
        function showSavingsModal() {
            calculateMonthlyBalance();
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;';
            
            let html = '<h2 style="margin-bottom: 20px; color: #1a862e;">üìä S·ªë d∆∞ theo th√°ng</h2>';
            
            // Sort months
            const sortedMonths = Object.keys(state.monthlyBalance).sort().reverse();
            
            if (sortedMonths.length === 0) {
                html += '<p style="color: #666;">Ch∆∞a c√≥ d·ªØ li·ªáu s·ªë d∆∞ theo th√°ng.</p>';
            } else {
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                sortedMonths.forEach(monthKey => {
                    const balance = state.monthlyBalance[monthKey];
                    const [year, month] = monthKey.split('-');
                    const monthNames = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 
                                      'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
                    const monthName = monthNames[parseInt(month) - 1];
                    const color = balance >= 0 ? '#28a745' : '#dc3545';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid ${color};">
                            <span style="font-weight: 600;">${monthName} ${year}</span>
                            <span style="color: ${color}; font-weight: bold;">${formatCurrency(balance)}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '<button onclick="this.closest(\'div[style*=\'position: fixed\']\').remove()" style="margin-top: 20px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">ƒê√≥ng</button>';
            
            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // View mode
        function setViewMode(mode) {
            currentViewMode = mode;
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            let buttonId;
            if (mode === 'all') buttonId = 'viewAll';
            else if (mode === 'week') buttonId = 'viewWeek';
            else if (mode === 'month') buttonId = 'viewMonth';
            if (buttonId) {
                document.getElementById(buttonId).classList.add('active');
            }
            renderTransactions();
        }

        // Filter functions
        function getFilteredTransactions() {
            let transactions = [...state.transactions];
            const timeFilter = document.getElementById('timeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const now = new Date();

            // Filter by time
            if (timeFilter === 'thisWeek') {
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                transactions = transactions.filter(t => new Date(t.date) >= startOfWeek);
            } else if (timeFilter === 'thisMonth') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                transactions = transactions.filter(t => new Date(t.date) >= startOfMonth);
            } else if (timeFilter === 'lastMonth') {
                const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                transactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= startOfLastMonth && tDate <= endOfLastMonth;
                });
            } else if (timeFilter === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (startDate) {
                    transactions = transactions.filter(t => t.date >= startDate);
                }
                if (endDate) {
                    transactions = transactions.filter(t => t.date <= endDate);
                }
            }

            // Filter by category
            if (categoryFilter !== 'all') {
                transactions = transactions.filter(t => t.category === categoryFilter);
            }

            return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Render functions
        function render() {
            renderKPIs();
            renderBudgetList();
            renderTransactions();
            renderChart();
            updateCategoryFilterOptions();
        }

        function renderKPIs() {
            const transactions = getFilteredTransactions();
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // T√≠nh t·ªïng thu nh·∫≠p th√°ng hi·ªán t·∫°i
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthIncome = state.transactions
                .filter(t => t.type === 'income' && new Date(t.date) >= startOfMonth)
                .reduce((sum, t) => sum + t.amount, 0);
            
            // T√≠nh t·ªïng gi√° tr·ªã mong mu·ªën ti√™u (targets)
            const expenseCategories = state.categories.filter(c => c.type === 'expense');
            let totalTarget = 0;
            expenseCategories.forEach(cat => {
                const targetKey = `expense_${cat.name}`;
                const target = state.targets[targetKey] || 0;
                totalTarget += target;
            });
            
            // S·ªë d∆∞ = T·ªïng thu nh·∫≠p - T·ªïng gi√° tr·ªã mong mu·ªën ti√™u
            const balance = monthIncome - totalTarget;
            
            // T√≠nh ti·∫øt ki·ªám = T·ªïng s·ªë d∆∞ c√°c th√°ng
            calculateMonthlyBalance();
            const savings = Object.values(state.monthlyBalance).reduce((sum, b) => sum + (b > 0 ? b : 0), 0);
            
            // Chi "Ph√°t sinh" = S·ªë d∆∞ √¢m (n·∫øu c√≥)
            const otherExpense = balance < 0 ? Math.abs(balance) : 0;
            
            // T·ªïng thu nh·∫≠p v√† chi ti√™u (t·∫•t c·∫£ giao d·ªãch)
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('balance').textContent = formatCurrency(balance);
            document.getElementById('savings').textContent = formatCurrency(savings);
            document.getElementById('otherExpense').textContent = formatCurrency(otherExpense);

            // Check for budget warnings
            const balanceCard = document.getElementById('balanceCard');
            let hasOverBudget = false;

            expenseCategories.forEach(cat => {
                const targetKey = `expense_${cat.name}`;
                const target = state.targets[targetKey];
                if (target) {
                    const monthExpense = getMonthExpenseForCategory(cat.name);
                    if (monthExpense > target) {
                        hasOverBudget = true;
                    }
                }
            });

            if (hasOverBudget) {
                balanceCard.classList.add('over-budget');
                document.title = '‚ö†Ô∏è V∆∞·ª£t ng√¢n s√°ch! - Qu·∫£n l√Ω t√†i ch√≠nh';
            } else {
                balanceCard.classList.remove('over-budget');
                document.title = 'üìí Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n';
            }
        }

        function getMonthExpenseForCategory(category) {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return state.transactions
                .filter(t => t.type === 'expense' && t.category === category && new Date(t.date) >= startOfMonth)
                .reduce((sum, t) => sum + t.amount, 0);
        }

        function renderBudgetList() {
            const budgetList = document.getElementById('budgetList');
            budgetList.innerHTML = '';
            
            // Render c·∫£ thu v√† chi
            const allCategories = state.categories;
            
            allCategories.forEach(cat => {
                const budgetItem = document.createElement('div');
                budgetItem.className = 'budget-item';
                
                const monthExpense = getMonthExpenseForCategory(cat.name);
                const monthIncome = getMonthIncomeForCategory(cat.name);
                const budget = state.budgets[cat.name] || 0;
                const targetKey = `${cat.type}_${cat.name}`;
                const target = state.targets[targetKey] || '';
                const isChecked = state.savingsCategories[cat.name] || false;
                // Ki·ªÉm tra v∆∞·ª£t ng√¢n s√°ch d·ª±a tr√™n gi√° tr·ªã chi t·ªëi ƒëa (target)
                const isOverBudget = target > 0 && monthExpense > target;
                
                if (isOverBudget && cat.type === 'expense') {
                    budgetItem.classList.add('over-budget');
                }
                
                let html = `
                    <div class="budget-item-header">
                        ${cat.type === 'expense' ? `
                            <input type="checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="toggleSavingsCategory('${cat.name}', this.checked)"
                                   style="width: 20px; height: 20px; margin-right: 10px;">
                        ` : ''}
                        <label style="flex: 1; margin: 0;">${cat.name}</label>
                    </div>
                `;

                if (cat.type === 'expense') {
                    // Gi√° tr·ªã chi t·ªëi ƒëa (target = max expense)
                    const remaining = target > 0 ? Math.max(0, target - monthExpense) : 0;
                    html += `
                        <div class="budget-target">
                            <label>Gi√° tr·ªã chi t·ªëi ƒëa (VND/th√°ng):</label>
                            <input type="number" 
                                   value="${target || ''}" 
                                   placeholder="Nh·∫≠p gi√° tr·ªã chi t·ªëi ƒëa"
                                   min="0"
                                   step="1000"
                                   onchange="updateTarget('${cat.name}', 'expense', this.value)">
                        </div>
                        <div class="budget-stats ${isOverBudget ? 'over' : ''}">
                            ƒê√£ chi: ${formatCurrency(monthExpense)}${target ? ` / C√≤n l·∫°i: ${formatCurrency(remaining)}` : ''}
                            ${isOverBudget ? ' ‚ö†Ô∏è V∆Ø·ª¢T NG√ÇN S√ÅCH!' : ''}
                        </div>
                    `;
                } else {
                    // Thu nh·∫≠p ch·ªâ hi·ªÉn th·ªã ƒë√£ thu (kh√¥ng c√≥ gi√° tr·ªã mong mu·ªën)
                    html += `
                        <div class="budget-stats">
                            ƒê√£ thu: ${formatCurrency(monthIncome)}
                        </div>
                    `;
                }
                
                // Th√™m n√∫t "Th√™m giao d·ªãch" cho m·ªói danh m·ª•c
                html += `
                    <button onclick="quickAddTransaction('${cat.type}', '${cat.name}')" 
                            style="width: 100%; margin-top: 10px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                        ‚ûï Th√™m giao d·ªãch
                    </button>
                `;
                
                budgetItem.innerHTML = html;
                budgetList.appendChild(budgetItem);
            });
        }

        function getMonthIncomeForCategory(category) {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return state.transactions
                .filter(t => t.type === 'income' && t.category === category && new Date(t.date) >= startOfMonth)
                .reduce((sum, t) => sum + t.amount, 0);
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            const transactions = getFilteredTransactions();

            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            Ch∆∞a c√≥ giao d·ªãch n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.
                        </td>
                    </tr>
                `;
                return;
            }

            if (currentViewMode === 'all') {
                // Hi·ªÉn th·ªã t·∫•t c·∫£ giao d·ªãch
                tbody.innerHTML = transactions.map(t => `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td><span class="transaction-type ${t.type}">${t.type === 'income' ? 'Thu' : 'Chi'}</span></td>
                        <td>${t.category}</td>
                        <td>${t.note || '-'}</td>
                        <td class="amount ${t.type}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="editTransaction(${t.id})" style="padding: 10px 18px; background: #2d5016; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px; font-size: 1em; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚úèÔ∏è S·ª≠a</button>
                                <button onclick="deleteTransaction(${t.id})" style="padding: 10px 18px; background: #8b4513; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üóëÔ∏è X√≥a</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else if (currentViewMode === 'week') {
                // Nh√≥m theo tu·∫ßn
                const groupedByWeek = groupTransactionsByWeek(transactions);
                tbody.innerHTML = renderGroupedTransactions(groupedByWeek, 'week');
            } else if (currentViewMode === 'month') {
                // Nh√≥m theo th√°ng
                const groupedByMonth = groupTransactionsByMonth(transactions);
                tbody.innerHTML = renderGroupedTransactions(groupedByMonth, 'month');
            }
        }

        function groupTransactionsByWeek(transactions) {
            const groups = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const weekStart = getWeekStart(date);
                const weekKey = formatWeekKey(weekStart);
                
                if (!groups[weekKey]) {
                    groups[weekKey] = {
                        period: weekKey,
                        date: weekStart,
                        transactions: [],
                        totalIncome: 0,
                        totalExpense: 0
                    };
                }
                groups[weekKey].transactions.push(t);
                if (t.type === 'income') {
                    groups[weekKey].totalIncome += t.amount;
                } else {
                    groups[weekKey].totalExpense += t.amount;
                }
            });
            return Object.values(groups).sort((a, b) => b.date - a.date);
        }

        function groupTransactionsByMonth(transactions) {
            const groups = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!groups[monthKey]) {
                    groups[monthKey] = {
                        period: monthKey,
                        date: new Date(date.getFullYear(), date.getMonth(), 1),
                        transactions: [],
                        totalIncome: 0,
                        totalExpense: 0
                    };
                }
                groups[monthKey].transactions.push(t);
                if (t.type === 'income') {
                    groups[monthKey].totalIncome += t.amount;
                } else {
                    groups[monthKey].totalExpense += t.amount;
                }
            });
            return Object.values(groups).sort((a, b) => b.date - a.date);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function formatWeekKey(date) {
            const endDate = new Date(date);
            endDate.setDate(endDate.getDate() + 6);
            return `${formatDate(date)} - ${formatDate(endDate)}`;
        }

        function renderGroupedTransactions(groups, type) {
            let html = '';
            groups.forEach(group => {
                const periodLabel = type === 'week' ? `Tu·∫ßn: ${group.period}` : `Th√°ng: ${formatMonthLabel(group.period)}`;
                html += `
                    <tr class="week-month-header">
                        <td colspan="6" style="background: #f8f9fa; font-weight: bold; padding: 15px;">
                            ${periodLabel} | Thu: ${formatCurrency(group.totalIncome)} | Chi: ${formatCurrency(group.totalExpense)} | S·ªë d∆∞: ${formatCurrency(group.totalIncome - group.totalExpense)}
                        </td>
                    </tr>
                `;
                group.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                    html += `
                        <tr>
                            <td>${formatDate(t.date)}</td>
                            <td><span class="transaction-type ${t.type}">${t.type === 'income' ? 'Thu' : 'Chi'}</span></td>
                            <td>${t.category}</td>
                            <td>${t.note || '-'}</td>
                            <td class="amount ${t.type}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="editTransaction(${t.id})" style="background: #f39c12;">‚úèÔ∏è S·ª≠a</button>
                                    <button onclick="deleteTransaction(${t.id})" class="danger">üóëÔ∏è X√≥a</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            });
            return html;
        }

        function formatMonthLabel(monthKey) {
            const [year, month] = monthKey.split('-');
            const monthNames = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 
                              'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function renderChart() {
            const canvas = document.getElementById('expenseChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const transactions = getFilteredTransactions();
            const expenseTransactions = transactions.filter(t => t.type === 'expense');
            
            // Calculate expenses by category
            const categoryExpenses = {};
            expenseTransactions.forEach(t => {
                categoryExpenses[t.category] = (categoryExpenses[t.category] || 0) + t.amount;
            });

            // Sort by amount and get top 8
            const sortedCategories = Object.entries(categoryExpenses)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            // Set canvas size first
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';

            if (sortedCategories.length === 0) {
                ctx.clearRect(0, 0, rect.width, rect.height);
                ctx.font = '20px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('Ch∆∞a c√≥ d·ªØ li·ªáu chi ti√™u', rect.width / 2, rect.height / 2);
                return;
            }

            const padding = 60;
            const chartWidth = rect.width - padding * 2;
            const chartHeight = rect.height - padding * 2;
            const barSpacing = chartHeight / sortedCategories.length;
            const maxAmount = Math.max(...sortedCategories.map(c => c[1]));

            // Clear canvas
            ctx.clearRect(0, 0, rect.width, rect.height);

            // Draw bars
            sortedCategories.forEach(([category, amount], index) => {
                const barHeight = barSpacing * 0.6;
                const y = padding + index * barSpacing + barSpacing * 0.2;
                const barWidth = (amount / maxAmount) * chartWidth;

                // Gradient
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#2d5016');
                gradient.addColorStop(1, '#5a8f3e');

                // Draw bar
                ctx.fillStyle = gradient;
                ctx.fillRect(padding, y, barWidth, barHeight);

                // Draw category name
                ctx.fillStyle = '#1a1a1a';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(category, padding + 5, y + barHeight / 2 + 4);

                // Draw amount
                ctx.fillStyle = '#2d5016';
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'right';
                const amountText = formatCurrency(amount);
                ctx.fillText(amountText, padding + barWidth - 5, y + barHeight / 2 + 4);
            });
        }

        function updateCategoryFilterOptions() {
            const categoryFilter = document.getElementById('categoryFilter');
            const currentValue = categoryFilter.value;
            
            categoryFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
            
            const allCategories = [...new Set(state.transactions.map(t => t.category))].sort();
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });

            if (allCategories.includes(currentValue)) {
                categoryFilter.value = currentValue;
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }


        // Initialize on load
        window.addEventListener('DOMContentLoaded', initAuth);
        
        // Re-render chart on window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (currentUser) {
                    renderChart();
                }
            }, 250);
        });
    </script>
</body>
</html>

